<html>
<head>
  <title>第五课 Rsync 2020-9-16 10:31:41</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/602326 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="3683"/>
<h1>第五课 Rsync 2020-9-16 10:31:41</h1>

<div>
<span><div><div><div><div>第五课  Rsync            2020-9-16 10:31:41</div><hr/><ul><li><div>rsync  <span style="color: rgb(255, 0, 0); font-weight: bold;">远程</span>同步，一般结合shell使用。 如何实现用shell执行同步？</div></li><li><div>rsync 是大集群常用的，研发<span style="color: rgb(255, 0, 0); font-weight: bold;">samba的作者</span>也是研发rsync的人</div></li><li><div>最小化安装时没有rsync的，我们需要<span style="color: rgb(255, 0, 0); font-weight: bold;">两端</span>都去安装才能使用</div></li><li><div>企业用的是<span style="color: rgb(255, 0, 0); font-weight: bold;">  daemon</span>，当做一个后台服务。运行的服务会有默认端口，是873</div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>rsync --version</div></div><ul><li><div>和scp相比，都能够实现本地和异地的传输。不管是<span style="color: rgb(255, 0, 0); font-weight: bold;">本地</span>还是<span style="color: rgb(255, 0, 0); font-weight: bold;">异地</span>，都是<span style="color: rgb(255, 0, 0); font-weight: bold;">全量备份</span>。</div></li><li><div>如果数据有10个G，结果只有一兆修改了，下一次再备份，那我会把10个G都复制过去。导致复制大文件，<span style="color: rgb(255, 0, 0); font-weight: bold;">效率太低</span>。rsync优点在于支持<span style="color: rgb(255, 0, 0); font-weight: bold;">增量备份</span>，我只需要在有修改的地方进行备份。</div></li><li><div><span style="text-decoration: underline;">完整备份</span>每一次都是将所有备份进行备份，你有多大，我就多大的备份，非常消耗时间。</div></li><li><div>还有一个叫<span style="text-decoration: underline;">差异备份</span>。你要经过一次完全备份，作为一个<span style="color: rgb(255, 0, 0); font-weight: bold;">时间戳</span>。<span style="color: rgb(255, 0, 0); font-weight: bold;">经过他每一次</span>都会进行一次<span style="color: rgb(255, 0, 0); font-weight: bold;">增量</span>备份。</div></li><li><div><span style="text-decoration: underline;">增量备份</span>，通过<span style="color: rgb(255, 0, 0); font-weight: bold;">上次备份的变化</span>，进行增量备份。</div></li></ul><div><br/></div><ul><li><div>通过以上可以看出差异备份和增量备份的不同，一个是完全备份，一个是普通备份。</div></li><li><div>rsync支持的是增量备份。并且可以有选择性保持属性，<span style="color: rgb(255, 0, 0); font-weight: bold; text-decoration: underline;">符号链接</span>，<span style="color: rgb(255, 0, 0); font-weight: bold; text-decoration: underline;">硬链接</span>，<span style="color: rgb(255, 0, 0); font-weight: bold; text-decoration: underline;">文件属性</span>，<span style="color: rgb(255, 0, 0); font-weight: bold; text-decoration: underline;">权限</span>，<span style="color: rgb(255, 0, 0); font-weight: bold; text-decoration: underline;">时间</span>。</div></li><li><div>同时我是能够将整个目录传输过去的</div></li><li><div>快速传输（全量后写一次只会增量）</div></li><li><div>压缩传输，rsync在传输数据过程中，可以实行<span style="color: rgb(255, 0, 0); font-weight: bold;">压缩</span>及解压缩的操作，因此可用更少的带宽。<span style="color: rgb(255, 0, 0); font-weight: bold;">其实我们现在HTTP也是实现压缩传输</span>。</div></li><li><div><span style="color: rgb(255, 0, 0); font-weight: bold;">安全</span>：可以使用scp、ssh的方式进行传输，也可以通过直接的socket进行连接。</div></li><li><div>rsync是 <span style="color: rgb(255, 0, 0); font-weight: bold;">C/S</span>模式，谁在<span style="color: rgb(255, 0, 0); font-weight: bold;">前</span>谁就是<span style="color: rgb(255, 0, 0); font-weight: bold;">源</span>，谁在<span style="color: rgb(255, 0, 0); font-weight: bold;">后</span>谁就是<span style="color: rgb(255, 0, 0); font-weight: bold;">目的</span>。</div></li><li><div>如果使用的是 daemon 守护进程，就会有个端口叫做873.</div></li><li><div>四个名词： 发起端、备份源、服务端（运行rsyncd服务，<span style="color: rgb(255, 0, 0); font-weight: bold;">需要备份的服务器</span><span style="font-size: unset; font-family: unset;"><span style="font-size: unset; font-family: unset; color: rgba(0, 0, 0, 0);">）、</span><span style="font-size: unset; font-family: unset;">客户端</span><span style="font-size: unset; font-family: unset; color: rgba(0, 0, 0, 0);">（）</span><span style="font-size: unset; font-family: unset; color: rgb(255, 0, 0); font-weight: bold;">存放备份数据</span><span style="font-size: unset; font-family: unset; color: rgba(0, 0, 0, 0);">）</span> </span></div></li></ul><div><br/></div><div><span style="font-size: 16pt; color: rgb(255, 0, 0); font-weight: bold;">数据同步方式</span></div><ul><li><div>当学到CI/CD  Gitlab和docker 镜像也是拉取，上传push</div></li><li><div>推：以一台为圆心，向下游的客户进行扩散和同步（<span style="color: rgb(255, 0, 0); font-weight: bold;">上传</span>）。</div></li><li><div>拉：下游客户端为核心，上游服务器进行拉取数据<span style="color: rgb(255, 0, 0); font-weight: bold;">下载</span>。</div></li></ul><div><br/></div></div><ul><li><div>在公司会有多层的服务器</div></li></ul><div><img src="第五课 Rsync 2020-9-16 103141_files/rsync.png" type="image/png" data-filename="rsync.png"/></div><ul><li><div>会有中心的服务器，为下游二级的服务器进行推送。因为根据节点，节点不超过二十台，那么推送还是ok的。如果有上百台再进行推送，是一个个的推。那么这个时候就会过高的延迟。在推送的时候又有数据更新了，那么我们又要向第一台发，后面的遥遥无期。</div></li><li><div>而拉取，我是发送请求，我可以一条条地去处理。下游会延迟过高，但我本地不会有太大的变化。</div></li></ul><div><br/></div><ul><li><div>如果我想解决延迟的问题，我们会开发<span style="font-weight: bold;">种子</span>。</div></li><li><div>这里会涉及到 <span style="color: rgb(255, 0, 0); font-weight: bold;">Xinetd</span> 的问题。这个服务类似于rsync，tftp。这种都属于轻量级的小服务。一般情况下，在6版本里面都是通过xinetd这个服务进行管理的。</div></li><li><div>在6版本安装了tftp后，会在 /etc/xinetd.d 这里看。7里面，其实服务可以自己管理，只不过tftp会仍然选择保存在xinetd.d目录下，这时候启动时需要分开启动的。</div></li></ul><div><img src="第五课 Rsync 2020-9-16 103141_files/rsync2.png" type="image/png" data-filename="rsync2.png"/></div><ul><li><div>我的rsync<span style="color: rgb(255, 0, 0); font-weight: bold;">服务</span>，其实是请求到<span style="color: rgb(255, 0, 0); font-weight: bold;"> xinetd的 873端口</span>进行备份的。</div></li></ul><div><br/></div><hr/><div><span style="font-size: 16pt; color: rgb(65, 173, 28); font-weight: bold;">实验</span></div><div>Master （源） 和 slave （目标）</div><div><img src="第五课 Rsync 2020-9-16 103141_files/Image.png" type="image/png" data-filename="Image.png"/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>[master]#  yum  -y install rsync xinetd</div><div>[slave]#  yum  -y  install rsync  xinetd       </div><div><br/></div><div>rpm -ql  rsync </div></div><ul><li><div>这个命令和scp基本一样，只是他在使用时需要用 冒号: 进行间隔。</div></li><li><div>当安装完之后，如果需要以后台的方式启动，需要 --daemon 。后期当成脚本用是需要  --daemon 参数的。</div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">rsync  --daemon</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">netstat  -antup | grep 873   #监听所有网段的</span></div></div><div><img src="第五课 Rsync 2020-9-16 103141_files/Image [1].png" type="image/png" data-filename="Image.png"/></div><ul><li><div>参数，下面那几个直接用  -a 代替了</div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>-a  权限保存模式，相当于  -rlptgoD  存档，递归，保持属性</div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">-------------------------------------------------</span></div><div>-r  复制所有下面的资料，表示<b><font color="#FF0000">递归</font></b></div><div>-p  保留<b><font color="#FF0000">档案权限</font></b>，</div><div>-t  保留<b><font color="#FF0000">时间点</font></b>，文件原有时间</div><div>-g  保留原有属组</div><div>-o  属主</div><div>-D  保留device 资讯（root only）</div><div>-l  保留所有的链接</div></div><ul><li><div>比较重要的参数，一个是a ，一个是<span style="color: rgb(255, 70, 53); font-weight: bold;">z</span></div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>-z ,--compress  压缩模式，当资料在传送到目的端进行档案压缩</div><div>-P  显示传输的进度</div><div>-v  更复杂的输出信息</div><div>--port  定义 rsyncd（daemon） 要运行的port</div><div><b><font color="#FF0000">--delete  删除那些目标位置有的文件，而备份源没有的文件</font></b></div><div>--password-file=FILE ， 从 FILE中获得密码</div><div>--bwlimit=KBPS  限制 I/O带宽</div><div>--exclude=filename  需要过滤的文件（就是排除）</div></div><ul><li><div>--delete 是用来删除源没有，而目的位置有的。举个例子，此时源的时候具备了</div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>源： 仓老师   木泉老师</div><div><font face="Monaco">目的：  thinkmo   </font></div></div><ul><li><div>当我使用 --delete 进行同步，请问我的<span style="color: rgb(255, 0, 0); font-weight: bold; text-decoration: underline;">源</span>里面有什么？这样是删除目的的，源里面照样有 苍老师 和 木泉老师，而目的里面变成了<span style="color: rgb(255, 0, 0); font-weight: bold;"> 苍老师 和 木泉老师</span>。</div></li><li><div>源位置没有 thinkmo ，而目的位置有，于是我删掉 thinkmo。但是我们本身是同步的过程，在生产环境里面参数 <span style="color: rgb(255, 0, 0); font-weight: bold;">--delete</span> （慎用），<span style="color: rgb(255, 0, 0); font-weight: bold;">万一有人把文件存错位置了呢</span>？除非这台机器命令禁止，这台就是为rsync而用的。不会有人使用，如果有人使用那只可能是黑客入侵，此时才会加上 --delete ，这是<span style="color: rgb(255, 0, 0); font-weight: bold;">为了防止有人放进去一些可执行的脚本，从而进行破坏</span>。</div></li><li><div>常用的参数  -azP</div></li></ul><div><br/></div><div><span style="font-size: 16pt; color: rgb(45, 79, 201); font-weight: bold;">使用Rsync 备份数据</span></div><ul><li><div>对master的网站根目录的 /var/www/html  目录 备份到  slave的 /web-back</div></li><li><div>通过标准输入批量修改密码</div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>[master]# useradd rget1; echo rget1:123456 | chpasswd</div><div>[slave]# useradd rget1 ; echo rget1:123456 | chpasswd</div></div><ul><li><div>正常情况下，<span style="color: rgb(255, 0, 0); font-weight: bold;">rsync 一定要指定用户，不要用 root 去运行</span>。</div></li><li><div>所以第一步 创建目录</div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">[master]# mkdir  -p  /var/www/html</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;"><strike>[master]# chown  rget1:rget1  /var/www/htm</strike>l   #假如这个目录有别的用处，就不要这么做</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">[slave]#  mkdir  -p  /web-back</span></div></div><ul><li><div>我们要为目录设置单独的权限，叫做文件ACL。</div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>[master]# setfacl  -R  -m  user:rget1:rwx  /var/www/html</div><div>[master]# setfacl  -R  -m  default:rget1:rwx  /var/www/html  #可以不打这行</div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">[master]#  getfacl  /var/www/html</span></div></div><div><img src="第五课 Rsync 2020-9-16 103141_files/Image [2].png" type="image/png" data-filename="Image.png"/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>[master]# cp  -r  /boot/*  /var/www/html    #用 /boot/ 下的文件，做测试数据</div></div><ul><li><div>在slave这边不用 setfacl ，直接用 chown ，分开来看效果</div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">[slave]#  chown rget1:rget1 -R  /web-back   #这个就是专门做备份的，而主上面的 /var/www/html 还有可能用的是apache</span></div></div><ul><li><div>实验</div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>[master]#  rsync -avz  --delete   /var/www/html/  rget1@192.168.1.122:/web-back                             #  &lt;-----注意<b><font color="#FF0000">加 <u>/ </u>和不加 <u>/</u> 是不一样的</font></b>。</div></div><ul><li><div>不加 / 是连同你这个目录都被同步过去，加 / 是同步你里边的内容。</div></li><li><div>第一步照样是输入你的密码<img src="第五课 Rsync 2020-9-16 103141_files/Image [3].png" type="image/png" data-filename="Image.png"/></div></li><li><div>可以看到他正在复制的过程 </div></li></ul><div><img src="第五课 Rsync 2020-9-16 103141_files/Image [4].png" type="image/png" data-filename="Image.png"/></div><ul><li><div>   这里是发送的时间，和传输文件的大小</div></li></ul><div><img src="第五课 Rsync 2020-9-16 103141_files/Image [5].png" type="image/png" data-filename="Image.png"/></div><ul><li><div>此时看到rsync 已经存在了，那么我们怎么结束他呢？直接kill就好了</div></li></ul><div><img src="第五课 Rsync 2020-9-16 103141_files/Image [6].png" type="image/png" data-filename="Image.png"/></div><ul><li><div>现在我们是使用  rsyncd.conf 进行复制和备份。以后我们也会用 rsync 的daemon 模式去运行它。也可以自定义</div></li></ul><div><img src="第五课 Rsync 2020-9-16 103141_files/Image [7].png" type="image/png" data-filename="Image.png"/></div><ul><li><div>我们需要自定义，因为现在用的是 自己创建的用户（非系统用户）。服务运行的是用的root用户</div></li></ul><div><img src="第五课 Rsync 2020-9-16 103141_files/Image [8].png" type="image/png" data-filename="Image.png"/></div><ul><li><div>这个和ssh的配置一样，都会有 全局和局部的配置，局部也叫模块化的配置。</div></li><li><div>上面这块是全局配置</div></li></ul><div><img src="第五课 Rsync 2020-9-16 103141_files/Image [9].png" type="image/png" data-filename="Image.png"/></div><ul><li><div>底下这块是局部配置</div></li></ul><div><img src="第五课 Rsync 2020-9-16 103141_files/Image [10].png" type="image/png" data-filename="Image.png"/></div><ul><li><div><span style="color: rgb(255, 0, 0); font-weight: bold;">局部的比全局的优先</span>。（38:36）</div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-size: 9pt; font-family: Monaco;">[<b><font color="#FF0000">slave</font></b>]#  vim  /etc/rsyncd.conf   #都是在 slave 上面做的 （<b><font color="#FF0000">拉取</font></b>）</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">----------------------------------------- </span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;"># 指定后台服务使用的端口号</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">port = 873</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">uid = root</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">gid = root</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">address = 192.168.1.121   #监听的IP地址</span></div><div>hosts allow = 192.168.1.0/255.255.255.0     #允许同步的客户端的IP ， 可以是网段，可以用 * 去表示所有</div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">use  chroot = yes       #是否牢笼，锁定家目录。黑客入侵后，无法在 家目录外创建文件</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;"><br/></span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">#最大的并发数，一般都是不变的，用来保护我的服务器</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">max connections = 5              # 如果是 0 的话，代表不限并发数</span></div><div><font face="Monaco">motd file = /etc/rsyncd.motd               # 提示，默认是没有的</font></div><div><font face="Monaco">pid file = /var/run/rsyncd.pid</font></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">lock file = /var/run/rsync.lock   #要有锁，不然你能运行，别人也能运行</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">log file = /var/log/rsyncd.log </span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">#----------上面的是全局的-----------------------</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;"># 再写一个模块，这个模块叫什么很重要</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;"># 模块名称为 wwwroot</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">[wwwroot]</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;"># 那我的模块名称究竟是对谁限制呢？</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">path = /web-back/       #这是路径，我<u>同步到哪个地方</u>去。</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">comment = used for web-data  root   # 用于 web-data 目录的根</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">read only = false   #这个我是读写的形式</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">list = yes   #是否允许查看模块信息</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">auth users = rsyncuser           #这是通过 非系统用户运行的，所以此时你的用户叫  rsyncuser（这个用户任意起，备份的用户和系统的用户没关系）</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">secrets file = /etc/rsync.passwd     #存放用户密码，对应 rsyncuser，rsyncuser 是不用在系统里面创建</span></div></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>[slave]# echo  'welcome to backup server' &gt; /etc/rsyncd.motd</div></div><ul><li><div>rsync的用户密码文件，一行就是一个</div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">[slave]# vim  /etc/rsync.passwd     </span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">------------------------------------------------</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">rsyncuser:123456</span></div></div><ul><li><div>像这种文件他的权限必须是 <span style="color: rgb(255, 0, 0); font-weight: bold;">600</span> 或者 <span style="color: rgb(255, 0, 0); font-weight: bold;">700</span>.这个权限不能在其他用户或者其他属组里面有，否则验证会失败</div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">[slave]# chmod 600 /etc/rsync.passwd</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">[slave]# systemctl restart xinetd</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">[slave]# systemctl  enable xinetd</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">[slave]# rsync --daemon  --config=/etc/rsyncd.conf         #如果不指定配置文件，他还不会按着你的配置文件启动</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">[slave]# netstat -lntu</span></div></div><div><img src="第五课 Rsync 2020-9-16 103141_files/Image [11].png" type="image/png" data-filename="Image.png"/></div><ul><li><div>然后在master上面做（如果 报错 no route to host ， 记得 防火墙放行 873）</div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>[master]# rsync  -avz  --delete  /var/www/html/  rsyncuser@192.168.1.122::wwwroot    #跟你的模块名称</div></div><div><img src="第五课 Rsync 2020-9-16 103141_files/Image [12].png" type="image/png" data-filename="Image.png"/></div><ul><li><div>然后又复制过去了</div></li></ul><div><img src="第五课 Rsync 2020-9-16 103141_files/Image [13].png" type="image/png" data-filename="Image.png"/></div><ul><li><div>而模块的位置是 /web-back，所以文件都被复制到了这里来</div></li></ul><div><img src="第五课 Rsync 2020-9-16 103141_files/Image [14].png" type="image/png" data-filename="Image.png"/></div><ul><li><div>一个是<span style="color: rgb(255, 0, 0); font-weight: bold; text-decoration: underline;">单冒号加上路径</span>，一个是<span style="color: rgb(255, 0, 0); font-weight: bold; text-decoration: underline;">双冒号加上路径</span>。生产环境肯定都是使用双冒号这种来传输。</div></li><li><div>这样需要输入密码，那么我们要做密码的处理。那么提前在本地写好就可以了</div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">[master]# vim /etc/rsync.passwd2</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">--------------------------------------</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">123456</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">[master]# chmod 600 /etc/rsync.passwd2       #但凡不是600、 700都会同步不过去</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">[slave]#  rm -f /web-back/*</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">[master]#  rsync -avz --delete  /var/www/html/  rsyncuser@192.168.1.122::wwwroot  --password-file=/etc/rsync.passwd2</span></div></div><ul><li><div>第二次传输不需要输入密码</div></li></ul><div><img src="第五课 Rsync 2020-9-16 103141_files/Image [15].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div><span style="font-size: 14pt; color: rgb(118, 0, 216); font-weight: bold;">脚本自动化</span></div><ul><li><div>简单的脚本</div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>[master]# vim autobackup.sh</div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">-----------------------------------------------</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">#!/bin/bash</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;"># 2020-9-16 14:23:07</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;"># Used to backup</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;"># Author by  dingyouqiang</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">rsync -avz --delete  /var/www/html/  rsyncuser@192.168.1.122::wwwroot  --password-file=/etc/rsync.passwd2</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;"><br/></span></div><div>[master]# chmod +x  autobackup.sh</div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">[master]# bash  autobackup.sh       #能运行就行</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">[slave]#  rm -rf /web-backup/*</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">[master]#  echo &quot;31 14 * * *  /bin/bash  /root/autobackup.sh &amp;&quot;   &gt;&gt; /var/spool/cron/root            #后台运行 </span></div></div><div><br/></div><div><br/></div><hr/><div><b style="font-size: unset;"><span style="font-size: 14pt; font-weight: bold; color: rgb(158, 0, 243); font-family: unset;">Inotify   Sersync</span></b></div><ul><li><div>我们之前讲过Inotify。在 生产环境中是不用 rsync 的定时任务的，是因为定时任务时间的把控性，时间最小是分钟，最长是月份</div></li><li><div>那么分钟如果过于频繁，那么上一个我没有备份完的时候，下一个我就要备份了，造成了<span style="color: rgb(255, 0, 0); font-weight: bold;">阻塞</span>。</div></li><li><div>月份，时间太长---那么有可能会发生数据丢失。</div></li><li><div>最好的方式是通过触发式更新。只要有了更新，我立刻就同步他。Inotify 适用于监控某个目录发生的变化，但是不能监控具体某个文件改了什么。他只知道你改了，但不知道你改了什么</div></li><li><div>现在大多数架构，比如金山云也是用的 rsync，但是用的 rsync  +  <span style="color: rgb(255, 0, 0); font-weight: bold;">sersync</span>  , 而这个算是 inotify 的升级版。他是<span style="color: rgb(255, 0, 0); font-weight: bold;">知道你具体的改变的</span>。</div></li></ul><div><br/></div><ul><li><div>那么现在是 master 作为数据源，装 sersync。</div></li><li><div>sersync  类似于 inotify-tools 的工具，一个衍生的版本。inotify 算是增量备份里面的完全备份，当数据量很大的时候，整个目录同步非常耗时（<span style="color: rgb(255, 0, 0); font-weight: bold;">rsync要对整个目录遍历查找对比文件</span>）。</div></li><li><div>sersync 记录目录中发生变化的（增删改）具体某个文件或目录的名字。</div></li><li><div>rsync 在同步时，只同步发生变化的文件或目录（增量当中的增量备份）</div></li></ul><div><br/></div><div>过程：</div><ol><li><div>在同步服务器上开启 sersync 访问，sersync 负责 监控配置路径中的文件系统时间变化</div></li><li><div>调用rsync命令把更新的文件同步到目标服务器</div></li><li><div>需要在主服务器配置 sersync，在同步目标服务器配置 rsync server</div></li></ol><div><a href="第五课 Rsync 2020-9-16 103141_files/sersync2.5.4_64bit_binary_stable_final.tar.gz"><img src="第五课 Rsync 2020-9-16 103141_files/204689d393f2ab906f4fb151c824e7ec.png" alt="sersync2.5.4_64bit_binary_stable_final.tar.gz"></a></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>[master]# cd /opt ;  wget sersync2.5.4_64bit_binary_stable_final.tar.gz</div><div>[master]# tar xf sersync2.5.4_64bit_binary_stable_final.tar.gz</div><div>[master]# mv  GNU-Linux-x86  sersync</div><div>[master]# cd  sersync</div></div><ul><li><div>sersync 是安装即用，算是绿色文件。里面只有启动文件，一个启动脚本<img src="第五课 Rsync 2020-9-16 103141_files/Image [16].png" type="image/png" data-filename="Image.png"/></div></li><li><div>需要修改配置文件，所以在改动之前做备份</div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">[master]#  cp  confxml.xml   conf.xml.bak        #早期的时候，所有的脚本都是xml</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">[master]#  vim  confxml.xml</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">------------------------------------------------</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">#第二十四行，监控我本地的目录，或者同步我的目录</span></div><div><span style="font-size: 9pt; font-family: Monaco;">&lt;localpath watch=&quot;<b><font color="#FF0000">/var/www/html/</font></b>&quot;&gt;</span></div><div><span style="font-size: 9pt; font-family: Monaco;">    &lt;remote ip=&quot;<b><font color="#FF0000">192.168.1.122</font></b>&quot; name=&quot;<b><font color="#FF0000">wwwroot</font></b>&quot;/&gt;</span></div><div><span style="font-size: 9pt; font-family: Monaco;">#第31行</span></div><div><span style="font-size: 9pt; font-family: Monaco;">&lt;auth start=&quot;<b><font color="#FF0000">true</font></b>&quot; users=&quot;<b><font color="#FF0000">rsyncuser</font></b>&quot; passwordfile=&quot;<b><font color="#FF0000">/etc/rsync.passwd2</font></b>&quot;/&gt;</span></div></div><ul><li><div>这个端口号，由于默认是 false ，所以874就不用改他了</div></li></ul><div><img src="第五课 Rsync 2020-9-16 103141_files/Image [17].png" type="image/png" data-filename="Image.png"/></div><ul><li><div>保存退出之后，我们开启进程。</div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>[master]# ./sersync2 -d -r -o /opt/sersync/confxml.xml             #-d表示daemon，-r 表示递归，-o表示指定配置文件</div></div><div><img src="第五课 Rsync 2020-9-16 103141_files/Image [18].png" type="image/png" data-filename="Image.png"/></div><ul><li><div>现在已经监听好了，那我怎么去看呢？</div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>[slave]#  cd /web-backup &amp;&amp; rm -rf * &amp;&amp; watch  ls -l</div><div>[master]# cd /var/www/html &amp;&amp; touch file{1..10}</div></div><ul><li><div>我自己测出来的是后来增加的文件都实时增加了。文件内容的增加或减少，只要你写入去了，都会被增量改变，传输过去rsync 服务器那边。</div></li></ul><div><img src="第五课 Rsync 2020-9-16 103141_files/Image [19].png" type="image/png" data-filename="Image.png"/></div><ul><li><div>所以我们要写一个小的脚本，让他自己去监控并且调用你。</div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>[master]# vim /opt/check_sersync.sh</div><div>--------------------------------------</div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">#!/bin/bash  </span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;"># 在你同步前要定义几个变量，我同步你肯定要有两个变量。一个是我的源文件，一个是目的文件。</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">sersync=&quot;/opt/sersync/sersync2&quot;   #这个是你的启动脚本</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">confxml=&quot;/opt/sersync/confxml.xml&quot;</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;"># 你要监控你的rsync是否已经启动了，使用 ps 去抓取进程</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">status=$(ps aux | grep -v grep | grep 'sersync2' |  wc -l)</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">if [ $status  -eq  0  ];then</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">    $sersync -d -r -o $confxml &amp;</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">else</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">    exit 0;</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">f</span><span style="font-family: Monaco; font-size: 9pt;">i</span></div><div><span style="font-family: Monaco; font-size: 9pt;"><br/></span></div><div><span style="font-family: Monaco; font-size: 9pt;">[master]# chmod +x  /opt/check_sersync.sh</span></div></div><ul><li><div>此时我只是监控了一个目录，如果监控两个目录呢？可以启动多个 confxml</div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>www_confxml=&quot;/opt/sersync/www_conxml.xml&quot;</div><div>bbs_confxml=&quot;/opt/sersync/bbs_confxml.xml&quot;</div><div>$sersync -d -r -o $www_confxml &amp;</div><div>$sersync -d -r -o $bbs_confxml &amp;</div></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div></div><hr/><div><br/></div></div><div><br/></div></span>
</div></body></html> 