<html>
<head>
  <title>第十一课 Iptables 2020-08-09 13:28:05</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/602326 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="2414"/>
<h1>第十一课 Iptables 2020-08-09 13:28:05</h1>

<div>
<span><div><div><font style="font-size: 14pt;"><span style="font-size: 14pt; color: rgb(65, 173, 28); font-weight: bold;">第十一课  Iptables  2020-08-09 13:28:05  </span></font></div><hr/><div>centos7 ，默认有iptablesd，但是如果想控制iptables的服务，或者添加规则至配置文件中生效，则需自行安装iptables的包</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">yum list | grep iptables</span></div></div><div><img src="第十一课 Iptables 2020-08-09 132805_files/ScreenClip.png" type="image/png" data-filename="ScreenClip.png"/></div><ul><li><div>以上的包，全部装了问题应该不大</div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>yum -y install iptables*    #我自己测试是装了 iptables-services这个包就有服务控制了</div></div><div><br/></div><ul><li><div>从7开始防火墙是firewalld，是<span style="color: rgb(255, 0, 0); font-weight: bold;">软件工具</span>。但我们用的是iptables。</div></li><li><div>iptables，三表五链，过滤规则</div></li><li><div>iptables参数很多，不需要记忆，只要会查就行</div></li><li><div>iptables只是一个管理工具，他由两部分组成----netfilter 和 iptables 组成。而<span style="color: rgb(255, 0, 0); font-weight: bold;">netfilter</span>他是作为一个<span style="font-style: italic; text-decoration: underline;">内核  </span>空间的功能。他是内核的一部分，由一些信息包和过滤表组成。</div></li><li><div>实际上很多数据组成，想要经过服务器，把服务器当做一个中转站。你必须开启一个参数叫 <span style="font-weight: bold;">ipforward</span>. 甚至有时要关闭icmp的重定向。这些其实要经过内核参数管理，谁管理？ netfilter。你能够直接管理吗？要通过一个用户层面的工具----叫<span style="color: rgb(227, 0, 0); font-weight: bold;">iptables</span>。 它使<span style="font-style: italic;">插入</span>、<span style="font-style: italic;">修改</span>和<span style="font-style: italic;">除去信息包</span><span style="text-decoration: underline;">过滤表中的规则</span>变得容易。</div></li><li><div>netfilters和iptables后期简称为iptables。</div></li><li><div>iptables 内置了 mangle , nat , filter 三张表 。但是我man  iptables的话  查找 -t（指定一个表格）。</div></li></ul><div><img src="第十一课 Iptables 2020-08-09 132805_files/Image.png" type="image/png" data-filename="Image.png"/></div><div><br/></div><ul><li><div>它里面还有一个raw表和security表。只是目前来说security压根不用，raw也极少使用</div></li></ul><div><div><br/></div><table style="border-collapse: collapse; min-width: 100%;"><colgroup><col style="width: 170px;"></col><col style="width: 187px;"></col><col style="width: 180px;"></col></colgroup><tbody><tr><td style="background-color: rgb(0, 168, 45); border: 1px solid rgb(0, 134, 36); width: 170px; padding: 8px;"><span style="color: rgb(255, 255, 255);">filter</span></td><td style="background-color: rgb(0, 168, 45); border: 1px solid rgb(0, 134, 36); width: 187px; padding: 8px;"><div><span style="color: rgb(255, 255, 255);">nat</span></div></td><td style="background-color: rgb(0, 168, 45); border: 1px solid rgb(0, 134, 36); width: 180px; padding: 8px;"><div><span style="color: rgb(255, 255, 255);">mangle</span></div></td></tr><tr><td style="width: 170px; padding: 8px; border: 1px solid;"><div>过滤表</div></td><td style="width: 187px; padding: 8px; border: 1px solid;"><div>地址转换表</div></td><td style="width: 180px; padding: 8px; border: 1px solid;"><div>过滤表</div></td></tr></tbody></table><ul><li><div>这三个表，所有的配置。只要你回车<span style="color: rgb(255, 0, 0); font-weight: bold;">立即生效</span>。（把所有请求拒绝，会导致远程连接断开）</div></li></ul></div><ul><li><div>如果iptables是一个工具，你可以把他看成一个选美大赛。</div></li><li><div>iptables<span style="color: rgb(255, 0, 0); font-weight: bold;">严格控制大小写</span>。所有的表都是小写，而我们所有的链都是大写，必须大写。</div></li><li><div>表里面有链，链里面我们写的叫规则---也就是具体要执行的内容。起到了过滤数据、转发的规矩。</div></li></ul><div><img src="第十一课 Iptables 2020-08-09 132805_files/Image [1].png" type="image/png" data-filename="Image.png"/></div><ul><li><div>filter这张表是负责<span style="color: rgb(255, 0, 0); font-weight: bold;">过滤</span>数据的。这一带的防火墙都是基于acl的，acl叫访问控制列表。我们对数据只有过滤或者允许，必须对数据<span style="font-weight: bold;">有动作</span>。任何一个<span style="color: rgb(255, 0, 0); font-weight: bold;">控制的流程和过滤</span>，都是<span style="color: rgb(255, 0, 0); font-weight: bold;">自顶向下以此匹配</span>。越严格越靠前，因为一旦匹配成功之后就不再匹配了。</div></li><li><div>里面规则链input , ouput , forward </div></li></ul><div><br/></div><ul><li><div>nat表，是用于网络地址转换的，用于公网和私网之间。所以，这个东西是在于<span style="color: rgb(227, 0, 0); font-weight: bold;">路由层次</span>。我的链是在于 prerouting,postrouting 和output输出  input 是7新加的。</div></li><li><div>mangle表，主要用于修改数据包内容上----比方说用来做流量整形。给包打标识，默认五个链都有--- input,output,forward,postrouting,prerouting</div></li><li><div>这几个链如何组合？当数据经过服务器，无论是进入服务器内部还是进行转发那我到底是什么一个顺序？</div></li></ul><div><div><br/></div><table style="border-collapse: collapse; min-width: 100%;"><colgroup><col style="width: 130px;"></col><col style="width: 130px;"></col><col style="width: 130px;"></col><col style="width: 130px;"></col><col style="width: 130px;"></col></colgroup><tbody><tr><td style="background-color: rgb(252, 83, 86); border: 1px solid rgb(251, 17, 21); width: 130px; padding: 8px;"><div><span style="color: rgb(255, 255, 255);">mangle</span></div></td><td style="background-color: rgb(253, 123, 57); border: 1px solid rgb(246, 84, 3); width: 130px; padding: 8px;"><div><br/></div></td><td style="background-color: rgb(253, 123, 57); border: 1px solid rgb(246, 84, 3); width: 130px; padding: 8px;"><div><br/></div></td><td style="background-color: rgb(253, 123, 57); border: 1px solid rgb(246, 84, 3); width: 130px; padding: 8px;"><div><br/></div></td><td style="background-color: rgb(253, 123, 57); border: 1px solid rgb(246, 84, 3); width: 130px; padding: 8px;"><div><br/></div></td></tr><tr><td style="background-color: rgb(0, 168, 45); border: 1px solid rgb(0, 134, 36); width: 130px; padding: 8px;"><div><span style="color: rgb(255, 255, 255);">input</span></div></td><td style="background-color: rgb(0, 168, 45); border: 1px solid rgb(0, 134, 36); width: 130px; padding: 8px;"><div><span style="color: rgb(255, 255, 255);">output</span></div></td><td style="background-color: rgb(0, 168, 45); border: 1px solid rgb(0, 134, 36); width: 130px; padding: 8px;"><div><span style="color: rgb(255, 255, 255);">forward</span></div></td><td style="background-color: rgb(0, 168, 45); border: 1px solid rgb(0, 134, 36); width: 130px; padding: 8px;"><div><span style="color: rgb(255, 255, 255);">prerouting（端口映射-私转公）</span></div></td><td style="background-color: rgb(0, 168, 45); border: 1px solid rgb(0, 134, 36); width: 130px; padding: 8px;"><div><span style="color: rgb(255, 255, 255);">postrouting（公转私-上网用）</span></div></td></tr><tr><td style="background-color: rgb(87, 191, 196); border: 1px solid rgb(59, 163, 168); width: 130px; padding: 8px;"><div>匹配目标IP是本机的数据包，是我的入口流量。</div></td><td style="background-color: rgb(87, 191, 196); border: 1px solid rgb(59, 163, 168); width: 130px; padding: 8px;"><div>出口数据包，一般不在此链上做配置</div></td><td style="background-color: rgb(87, 191, 196); border: 1px solid rgb(59, 163, 168); width: 130px; padding: 8px;"><div>匹配流经本机的数据包</div></td><td style="background-color: rgb(87, 191, 196); border: 1px solid rgb(59, 163, 168); width: 130px; padding: 8px;"><div>用来修改目的地址，用来做DNAT</div></td><td style="background-color: rgb(87, 191, 196); border: 1px solid rgb(59, 163, 168); width: 130px; padding: 8px;"><div>修改源地址来做SNAT</div></td></tr></tbody></table><ul><li><div>像家用共享上网，我们使用snat把源地址转换了。目的一般都是服务器接收，然后我们做后边集群分发处理。</div></li><li><div>raw表有 prerouting 和 output 链，这几个链匹配的顺序，先匹配 raw 再匹配mangle 再 nat，最后filter</div></li></ul><div><img src="第十一课 Iptables 2020-08-09 132805_files/Image [2].png" type="image/png" data-filename="Image.png"/></div></div><ul><li><div>范围越来越精确，mangle是一些特殊的标识，nat看是否经过一些特定的转发，如果进入了我们再看filter具体的数据。</div></li><li><div>raw表用于处理异常，此时他包括的链有prerouting和output一般使用不到。</div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">iptables -L  #表示显示当前iptables设置的规则，默认情况我们显示的是filter表。</span></div></div><div><img src="第十一课 Iptables 2020-08-09 132805_files/Image [3].png" type="image/png" data-filename="Image.png"/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>#如果我们想看别的就用 -t ，-t表示指定表格</div><div>iptables -L -t nat  #刚好看到是 input output 和 postrouting  input <b><font color="#FF0000">有四个</font></b></div></div><div><img src="第十一课 Iptables 2020-08-09 132805_files/Image [4].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>iptables -t mangle -L</div></div><div><img src="第十一课 Iptables 2020-08-09 132805_files/Image [5].png" type="image/png" data-filename="Image.png"/></div><ul><li><div>通过路由找到本机，进入到本机，转发到哪里，出去本机，路由。顺序都是定好的。</div></li></ul><div><br/></div><div><br/></div><hr/><div><font style="font-size: 14pt;"><span style="font-size: 14pt; color: rgb(118, 0, 216); font-weight: bold;">表--链--规则</span></font></div><div><br/></div><ul><li><div>我们每次都会用  iptables -F 清空里面的配置。所以现在使用 iptables -L 来看的话，里面是没有任何的规则的。<span style="font-size: unset; color: unset; font-family: unset;"> </span></div></li><li><div><span style="font-size: unset; color: unset; font-family: unset;">  </span><img src="第十一课 Iptables 2020-08-09 132805_files/Image [6].png" type="image/png" data-filename="Image.png" style="color: unset; font-family: unset; font-size: unset;"/></div></li><li><div>target看我们的目标默认是拒绝还是允许。来自哪里，源是哪里。协议是什么。通通都没有</div></li><li><div>来看看过滤包是怎么做的</div></li></ul><div><img src="第十一课 Iptables 2020-08-09 132805_files/Image [7].png" type="image/png" data-filename="Image.png"/></div><ul><li><div>当数据包流经我们的服务器，我第一步要匹配路由。<span style="text-decoration: underline;">PREROUTING</span>准备路由，寻找路由，问<span style="color: rgb(255, 0, 0);">谁有啊</span>？mangle和nat有。有了他之后我们进到下一步来----先进<span style="text-decoration: underline;">mangle表过滤</span>，再进<span style="text-decoration: underline;">nat过滤</span>。谁优先？mangle优先，谁具体？nat具体。</div></li><li><div>但是此时如果两张表都有，如果<span style="font-style: italic;">mangle过滤</span>，<span style="font-style: italic;">nat允许</span>呢？是会被<span style="text-decoration: underline;">过滤</span>。跟规则一样，<span style="color: rgb(255, 0, 0); font-weight: bold;">表在前</span>先听表的。</div></li><li><div>找到了路由之后有两种情况，一种是把他当做<span style="color: rgb(255, 0, 0); font-weight: bold;">中转站</span>，我不经过你的服务进行处理。你只要把我转发出去就好了，把你当做<span style="font-weight: bold;">路由器</span>。</div></li><li><div>那么我这边进来了第一种情况，我只是把你当做路由器进行转发（<span style="color: rgb(255, 0, 0);">FORWARD</span>），然后也是先经mangle再经filter。这个FORWARD是直接流过你，<span style="color: rgb(255, 0, 0); font-weight: bold;">不进入</span>你任何的<span style="color: rgb(255, 0, 0); font-weight: bold;">服务里面</span>。</div></li><li><div>最后POSTROUTING，先经过mangle再经过nat。</div></li><li><div>为什么会经过你呢？</div></li></ul><div><img src="第十一课 Iptables 2020-08-09 132805_files/Image [8].png" type="image/png" data-filename="Image.png"/></div><ul><li><div>在这个时候我再加上mangle表和filter表，如果是7的话还会有一个nat。</div></li><li><div>经过本地数据处理之后，我来告诉你来往哪里走。尤其是在<span style="text-decoration: underline;">一个设备多个网卡的情况下</span>，</div></li><li><div>最后都是经过mangle和nat出去</div></li></ul><div><img src="第十一课 Iptables 2020-08-09 132805_files/Image [9].png" type="image/png" data-filename="Image.png"/></div><ul><li><div>一种是发给防火墙本身的数据包的--不需要被<span style="text-decoration: underline;">filte</span>r过滤的。一种是需要经过防火墙的数据包--需要被filter过滤的。</div></li><li><div>当一个数据包进入网卡的时候，他首先进入的是PREROUTING链，内核根据数据包根据目的IP判断需要进入还是经过。如果数据包会进入本机的，他就会沿着上面那个图向下移动，所以要有<span style="text-decoration: underline;">INPUT</span>，数据包到了INPUT链之后，任何进程都会收到他。</div></li><li><div>本机上运行的程序可以发送数据包，这些数据就会如上面的图向右移动，经过<span style="text-decoration: underline;">OUTPUT链</span>然后到达<span style="text-decoration: underline;">POSTROUTING链</span>输出。</div></li><li><div>如果数据包是要转发出去，且内核允许转发，数据包就会向右移动，经过FORWARD链到达POSTROUTING链输出。<span style="color: rgb(255, 0, 0); font-weight: bold;">就是iptables forward ，forward链必须搭配使用，不然没法转。</span></div></li><li><div>表链的优先级 ：  raw &gt; mangle &gt; nat &gt; filter</div></li><li><div>链间的匹配顺序：  </div></li></ul><ol><li><div>入站数据： PREROUTING -&gt; INPUT   一定是经过路由之后进入INPUT</div></li><li><div>出站数据： OUTPUT -&gt; POSTROUTING   出去之后再POSTROUTING找路由，我只有出了本地才能够寻址。</div></li><li><div>转发数据： PREROUTING -&gt; FORWARD -&gt; POSTROUTING  转发的话还有数据处理吗？</div></li></ol><ul><li><div>链内的匹配顺序</div></li></ul><ol><li><div>自上向下按顺序依次进行检查，找到相匹配的规则即停止</div></li><li><div>若在该链内找不到相匹配的规则，则按该链的默认策略处理（未修改的状况下，默认策略为允许）</div></li></ol><div><br/></div><ul><li><div>那么默认策略在哪呢？iptables -L  在链后面的有个策略默认为允许</div></li></ul><div><img src="第十一课 Iptables 2020-08-09 132805_files/Image [10].png" type="image/png" data-filename="Image.png"/></div><ul><li><div>那么我们说这个策略最终执行的叫动作。最起码有四个，<span style="color: rgb(255, 0, 0); font-weight: bold;">动作也是必须大写</span>。</div></li></ul><hr/><div><font style="font-size: 16pt;"><span style="font-size: 16pt; color: rgb(54, 101, 238); font-weight: bold;">iptables 部署</span></font></div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>yum -y install iptables</div><div>systemctl stop firewalld  </div><div>systemctl disable firewalld #做实验前先关闭firewalld</div><div>vim /etc/sysconfig/iptables-config     #这是iptables的主配置文件</div><div>-------------------------里面的模块都还没有使用</div></div><div><img src="第十一课 Iptables 2020-08-09 132805_files/Image [11].png" type="image/png" data-filename="Image.png"/></div><ul><li><div>IPTABLES_MODULES  <span style="text-decoration: underline;">空的，还没有使用</span></div></li><li><div>IPTABLES_SAVE_ON_STOP =no  <span style="text-decoration: underline;">不保存里面的东西，这是默认情况下</span></div></li><li><div>IPTABLES_SAVE_ON_RESTART=no  <span style="text-decoration: underline;">我们的规则在重启的时候不保存。除了我们默认系统生成的策略以外，但凡是修改之后</span><span style="color: rgb(255, 0, 0); font-weight: bold; text-decoration: underline;">关闭或者重启</span><span style="text-decoration: underline;">防火墙，他都会</span><span style="color: rgb(255, 0, 0); font-weight: bold; text-decoration: underline;">恢复成默认</span><span style="text-decoration: underline;">。你要做保存才行或者再这里改yes</span></div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">service iptables save</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">iptables-save  #这个也可以</span></div></div><div><br/></div><ul><li><div>上面是配置文件，我们启动它或者开机自启可以通过systemctl来控制</div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>systemctl start iptabels</div><div>systemctl enable iptabels</div></div><div><img src="第十一课 Iptables 2020-08-09 132805_files/Image [12].png" type="image/png" data-filename="Image.png"/></div><ul><li><div>以上是iptables里面默认的规则</div></li></ul><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>systemctl restart itpables </div><div>iptables -L  #安装重启之后，我的规则都没有了</div></div><div><img src="第十一课 Iptables 2020-08-09 132805_files/Image [13].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>iptables -F #清空规则</div><div>iptables-save</div><div>iptables -L</div></div><ul><li><div>后期熟悉了iptables之后，是不需要在命令行写的，可以直接在配置文件上修改</div></li></ul><div><br/></div><ul><li><div>iptables 命令的语法格式</div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>iptables  [-t 表名] 管理选项 [链名] [条件匹配] [-j 目标动作或跳转]     &lt;---------划中括号的地方表示我可以省略的地方</div></div><ul><li><div>不指定表名时，默认表示filter表</div></li><li><div>不指定链名是，默认表示该表内所有链</div></li><li><div>除非设置规则链的缺省策略，否则需要制定匹配条件</div></li><li><div>下图为语法选择，就是做一个搭配</div></li></ul><div><img src="第十一课 Iptables 2020-08-09 132805_files/Image [14].png" type="image/png" data-filename="Image.png"/></div><ul><li><div>-A  表示添加、追加，一般都是在最尾上追加</div></li><li><div>-D  删除</div></li><li><div>-I   插入---你可以制定行数插入</div></li><li><div>-p  你可以制定基于tcp的</div></li><li><div>-j   ACCEPT   把他允许</div></li></ul><div><br/></div><hr/><div><span style="font-size: 16pt; color: rgb(79, 0, 154); font-weight: bold;">iptables 操作命令</span></div><ul><li><div>-A 、-I 、-D、-P、-F</div></li></ul><ol><li><div>-A &lt;链名&gt;  APPEND，追加一条规则（放到最后），他没有办法制定我要添加在第几行，他只能保存在最后。那么此时 -t 这个是可以省略的</div></li></ol><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>iptables -t filter -A INPUT -j DROP  #我可以在 -A 后指定INPUT，让他扔掉 ，拒绝所有人访问服务器</div><div>iptables -A INPUT -j DROP #此时我虽然拒绝了所有连接，但是我的ssh连接并不会断掉</div></div><ul><li><div>因为在前面会有这条规则，所以没有断开ssh,dpt表示目的端口。从哪来的，去哪的都被drop掉</div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>ACCEPT  tcp --  anywhere   anywhere   state NEW tcp dpt:ssh</div><div>iptables -L -n</div></div><div><br/></div><div>      2. -I &lt;链名&gt; [规则号码]    这是表示我在哪里插入一条规则。我得知道行号吧，我得挨个去数吗？有row  id吗？我得知道序列号吧？</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>iptables -L -n --line-numbers</div></div><ul><li><div>比方说我现在想在 第5行处插入，第5行的意思就是说我会<span style="font-weight: bold;">取代他</span>，把他<span style="color: rgb(227, 0, 0); font-weight: bold;">往后移</span></div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>iptables -I INPUT 5 -j DROP</div></div><ul><li><div>如果你啥数字都不加，表示第一，代表在开头插入</div></li></ul><div><br/></div><div>     3.  -R就是代替接口， Replays 替换第几条规则。也就是说不是往后移，而是把你这条<span style="color: rgb(255, 0, 0); font-weight: bold;">覆盖</span>了，顶替你了。</div><div>     4.  -D&lt;链名&gt; &lt;规则号码 | 具体规则内容&gt;   指定哪一行删除规则，如果我真的不记得他是哪一个了 。那我也可以按照具体的命令，不用怕删错</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>iptables -D INPUT -s 192.168.01.1 -j DROP  # 按内容匹配</div><div>iptables -D INPUT -j DROP</div><div>iptables -D INPUT 5 -j DROP</div></div><div><br/></div><div>     5. -P &lt;链名&gt; &lt;动作&gt;   设置某个链的<span style="color: rgb(227, 0, 0); font-weight: bold;">默认规则</span>，-P是唯一一个我们在部署策略时不需要 -j 参数动作的 ，只需要指定一个链就可以了。</div><ul><li><div>此时如果指定</div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>iptables -P INPUT  DROP</div><div>iptabels -L </div></div><div><img src="第十一课 Iptables 2020-08-09 132805_files/Image [15].png" type="image/png" data-filename="Image.png"/></div><ul><li><div>下方的规则我们依次匹配，如果都没有了，我们就匹配DROP</div></li><li><div>一般来说，生产环境都是默认拒绝，然后开放某些策略。----跟思科是一个逻辑</div></li></ul><ol start="6"><li><div>  iptabels  -F 临时清除表策略，那么我要是想具体的清空哪个表呢？那就在前面跟上某个表，他没有办法清链，它只能清表的</div></li></ol><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>iptables -t nat -F     # 链的话你得指出来，不指他是不会清的</div><div>iptables -F  FORWARD</div><div>iptables -L</div></div><ul><li><div>iptables -F  不影响 -P 设置的默认策略 。-P参数需要手动去修改</div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>iptables -P INPUT ACCEPT</div></div><div><br/></div><ul><li><div>crontab</div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>*/15 * * * * iptabels -P INPUT ACCEPT</div><div>*/15 * * * * iptables -F</div></div><div><br/></div><div>     7  -Z  将封包计数器清0 ，这个不怎么用---有数据交互的时候才会有数字</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>iptables -Z INPUT</div></div><div><br/></div><ol start="8"><li><div>    -L [链名]   列出规则</div></li></ol><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>v:   显示详细信息，包括每条规则的匹配包数量和匹配字节数</div><div>x:   在v的基础上，禁止自动单位换算（K、M）</div><div>n:   只显示IP地址和端口号码，不显示域名和服务名称</div><div>--line-numbers  可以查看规则号</div></div><div><br/></div><ul><li><div>此时光查nat里面会有东西吗？</div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>iptables -t nat -L</div><div>iptables -t nat -vnL</div></div><div><img src="第十一课 Iptables 2020-08-09 132805_files/Image [16].png" type="image/png" data-filename="Image.png"/></div><ul><li><div>会多出来一些字节数，数据包数。</div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>iptables -t filter -vnL</div></div><div><img src="第十一课 Iptables 2020-08-09 132805_files/Image [17].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><hr/><div><font style="font-size: 16pt;"><span style="font-size: 16pt; color: rgb(54, 101, 238); font-weight: bold;">匹配条件</span></font></div><ul><li><div>流入、流出接口 （-i 、 -o），比方说 -i ens32 -o ens34 代表从我们32流进来的流量都要34流出去。</div></li><li><div>来源、目的地址（-s、-d）  ， 例： -s IP 或者IP段   -d 跟具体的IP或者具体IP段</div></li><li><div>协议类型 （-p）指的是 tcp 还是 udp ，或者说更细节的可以跟 icmp，下面还会有, --icmp-type echo ?  tracert ?</div></li><li><div>来源、目的端口 （--sport、--dport），这个必须联合-p使用，因为所有的服务都是基于协议，所有协议都属于某一个端口</div></li></ul><div><br/></div><div><br/></div><div><font style="font-size: 16pt;"><span style="font-size: 16pt; color: rgb(54, 101, 238); font-weight: bold;">按照网络接口匹配</span></font></div><ul><li><div>-i &lt;匹配数据进入的网络接口&gt;  此参数主要应用于nat表，例如目标地址转换，接收进程之后，从一个口出去。那么此时做我们的目标地址转换，也就是其典型的DNAT。</div></li><li><div>-i  eth0  比方说匹配是否从我们这个 eth0 网卡进来的</div></li><li><div>-i  ppp0  或者说匹配是否从 ppp0进来 ----&gt; 这个是vpn</div></li><li><div>-o  去匹配我们的流量出口   -o  eth0   -o  ppp0</div></li><li><div>-s  按来源目的地址匹配，怎么去表示地址段呢？</div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div> -s  192.168.0.1</div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">  -s    192.168.1.0/24</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">  -s      192.168.0.0/16</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">  # 域名也可以直接用</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">  # 如果什么也不加 ， 连 s都不加，就表示any，任意</span></div></div><ul><li><div>-d 按目的地址匹配</div></li><li><div>-p &lt;匹配协议类型&gt;  可以为空。ping 是type 8 ，pong是type 0 ，禁止ping是为了防止ddos攻击</div></li><li><div>--sport &lt;匹配源端口&gt;  按照来源的端口，可以是个别的也可以是范围的，</div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>--sport 1000</div><div>--sport 1000:3000</div><div>--sport :3000     #3000以下的数据包</div></div><ul><li><div>--dport  一样    --sport和--dport 必须配合 -p参数使用</div></li></ul><div><br/></div><hr/><div><font style="font-size: 16pt;"><span style="font-size: 16pt; color: rgb(26, 144, 185); font-weight: bold;">应用案例</span></font></div><ol><li><div>端口匹配</div></li></ol><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>-p  udp  --dport  53   #拒绝dns服务  dns出了udp之外还有tcp，所以一定两个都给他做上</div></div><ol start="2"><li><div>地址匹配</div></li></ol><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>-s  10.1.0.0/24  -d 172.16.0.0/16   #匹配来自 10.1.0.0/24 去往 172.17.0.0/16的所有数据包</div></div><ol start="3"><li><div>端口和地址联合匹配</div></li></ol><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>-s  192.168.0.1 -d  www.abc.com  -p tcp --dport 80  #匹配来自192.168.0.1，去往 www.abc.com 的80端口的TCP数据包</div></div><div><img src="第十一课 Iptables 2020-08-09 132805_files/Image [18].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><ul><li><div>条件写的越多，匹配越细致，匹配范围越小。</div></li></ul><hr/><div>动作（处理方式）</div><div><br/></div><ul><li><div>ACCEPT  允许，放行</div></li><li><div>DROP  --  拒绝了，不告诉你</div></li><li><div>SNAT  -- 共享上网</div></li><li><div>DNAT  -- 反向代理</div></li><li><div>REJECT   --  拒绝了，还要告诉你</div></li><li><div>LOG  --  记录日志动作的</div></li></ul><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>-j  SNAT  --to  IP[-IP][:端口-端口]  (nat表的POSTROUTING链)    #一般SNAT是用来共享上网的，支持转换为单IP，也支持转换为IP地址池（一组连续的IP地址），你们上网拨号的话其实都是获得一个地址池，没有说我是单独获取一个IP地址的。除非你是在园区或者你的公司。</div><div>iptables -t nat -A POSTROUTING -s 192.168.0.0/24 -j SNAT --to 1.1.1.1  </div><div>iptables -t nat -A POSTROUTING -s 192.168.0.0/24 -j SNAT --to 1.1.1.1-1.1.1.10</div></div><div><br/></div><ul><li><div>例如 ： 把 eth0 进来的要访问TCP/80 的数据包目的地址改为 192.168.0.1，你也可以在后面跟上端口，转换成你地址的某某端口</div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80  -j DNAT --to  192.168.0.1</div></div><div><br/></div><ul><li><div>-j  MASQUERADE  伪装。动态源地址转换。</div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>iptables -t nat -A POSTROUTING -s 192.168.0.0/24  -o eth0 -j MASQUERADE #将源地址是192.168.0.0的数据包进行伪装,转换为出口的eth0上的地址，既然是-o ，那就应该是 -A POSTROUTING 。至于你是谁，就看eth0上面的地址了。</div></div><ul><li><div>你也可以附加很多的模块</div></li></ul><ol><li><div>按包状态匹配（state）   ，不知名的端口需要按状态去匹配了</div></li></ol><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>0.0.0.0/0  state NEW tcp dpt:22</div><div>-m  state --state 状态</div><div>NEW : 有别于tcp的syn，如果我们发送一个流的初始化包，状态就会在OUTPUT链里被设置成NEW，当我们收到回应的包是，状态就会在PREROUTING链里被设置为ESTABLISHED。如果第一个包不是本地产生的，那就会在PREROUTING链里被设置为NEW状态</div><div><font face="Monaco">ESTABLISHED：连接状态---连接成功啦</font></div><div><font face="Monaco">RELATED： 衍生态，与conntrack关联（ftp）</font></div><div><font face="Monaco">INVALID：不能被识别属于哪个连接或者没有任何状态</font></div></div><div><br/></div><ul><li><div>iptables 本身是基于ACL去抓包，分析你的数据包，然后进行定位的。</div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>iptables -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT</div></div><div><img src="第十一课 Iptables 2020-08-09 132805_files/Image [19].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><ul><li><div>这些状态是可以一起使用的，以便匹配数据包。</div></li><li><div>按来源MAC匹配（mac）这个就相当于绑定了，mac和ip有绑定，可以防止ARP攻击、欺骗</div></li></ul><div><br/></div><ul><li><div>按包速率匹配 （limit）</div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>-m  limit --limit 匹配速率 [--burst 缓冲数量]</div><div>iptables -A FORWARD -d 192.168.0.1 -m limit --limit 50/s -j ACCEPT</div><div>iptables -A FORWARD -d 192.168.0.1 -j DROP</div></div><div><br/></div><div><br/></div><ul><li><div>多端口匹配 （multiport）</div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>-m  multiport &lt;--sports | --dports | --ports&gt;  端口1[端口2,...,端口n]</div><div>iptables -A INPUT -p tcp -m multiport --dports 21,22,25,80,110 -j ACCEPT</div></div><div><br/></div></div><div><br/></div></span>
</div></body></html> 