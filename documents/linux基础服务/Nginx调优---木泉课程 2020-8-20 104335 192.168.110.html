<html>
<head>
  <title>Nginx调优---木泉课程 2020-8-20 10:43:35 192.168.110</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/602326 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="2834"/>
<h1>Nginx调优---木泉课程 2020-8-20 10:43:35 192.168.110</h1>

<div>
<span><div><div>Nginx调优---木泉课程<span>    </span>  2020-8-20 10:43:35        192.168.110</div><hr/><ul><li><div>练习调优</div></li></ul><div><img src="Nginx调优---木泉课程 2020-8-20 104335 192.168.110_files/Image.png" type="image/png" data-filename="Image.png"/></div><ul><li><div>方便操作</div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>echo  'a=/usr/local/nginx/conf' &gt;&gt; /etc/profile</div><div>echo  'b=/usr/local/nginx/html' &gt;&gt; /etc/profile</div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">echo    'c=</span>/usr/local/nginx/logs' &gt;&gt; /etc/profile</div><div>source /etc/profile</div></div><ul><li><div>查看nginx启动的用户，我虚拟机用的脚本设置了nginx用户。如果没有的话，<span style="color: rgb(227, 0, 0); font-weight: bold;">默认就是nobody</span>。</div></li></ul><div><img src="Nginx调优---木泉课程 2020-8-20 104335 192.168.110_files/Image [1].png" type="image/png" data-filename="Image.png"/></div><div><img src="Nginx调优---木泉课程 2020-8-20 104335 192.168.110_files/Image [2].png" type="image/png" data-filename="Image.png"/></div><div><img src="Nginx调优---木泉课程 2020-8-20 104335 192.168.110_files/Image [3].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><ul><li><div>默认nginx一个master进程，<span style="color: rgb(227, 0, 0); font-weight: bold;">一个master进程会控制一个worker进程</span>。而工作进程可以看到只有一个</div></li></ul><div><img src="Nginx调优---木泉课程 2020-8-20 104335 192.168.110_files/Image [4].png" type="image/png" data-filename="Image.png"/></div><ul><li><div>那么一个工作进程会有多少个连接呢？最大的并发为1024</div></li></ul><div><img src="Nginx调优---木泉课程 2020-8-20 104335 192.168.110_files/Image [5].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><ul><li><div><span style="color: rgb(255, 0, 0); font-weight: bold;">一般工作的时候，经验值为</span>:   基本上在8万的并发。</div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>worker_processes  8;</div><div>events {</div><div>    worker_connections 10240;</div><div>}</div></div><div><br/></div><ul><li><div>无论是apache也好，nginx也好，在运行的时候我们会消耗资源。我们apache一个会消耗内存<span style="color: rgb(255, 0, 0); font-weight: bold;">处理</span>我们的<span style="color: rgb(255, 0, 0); font-weight: bold;">请求</span>，nginx由于是在前端做<span style="font-weight: bold;">负载均衡</span>。那么他是对<span style="color: rgb(255, 0, 0); font-weight: bold;">流量</span>的<span style="color: rgb(255, 0, 0); font-weight: bold;">处理</span>。可能有 ip_hash 、url_hash、rr、wrr等等。这些进行处理的时候回消耗cpu，而我可以通过top在查看的时候看到只有一个cpu  <img src="Nginx调优---木泉课程 2020-8-20 104335 192.168.110_files/Image [6].png" type="image/png" data-filename="Image.png"/>  。或者我可以通过 /proc/cpuinfo 这个文件去查看。</div></li></ul><div><img src="Nginx调优---木泉课程 2020-8-20 104335 192.168.110_files/Image [7].png" type="image/png" data-filename="Image.png"/></div><div><img src="Nginx调优---木泉课程 2020-8-20 104335 192.168.110_files/Image [8].png" type="image/png" data-filename="Image.png"/></div><div><img src="Nginx调优---木泉课程 2020-8-20 104335 192.168.110_files/Image [9].png" type="image/png" data-filename="Image.png"/></div><div><img src="Nginx调优---木泉课程 2020-8-20 104335 192.168.110_files/Image [10].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><ul><li><div>重启之后 ，查看多个逻辑cpu</div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>top</div><div>1    #按1</div></div><div><img src="Nginx调优---木泉课程 2020-8-20 104335 192.168.110_files/Image [11].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><ul><li><div> 同时我的nginx可以根据cpu数来进行调整。下面这样写代表有4个核，我们是把我们的进程分配cpu上，或者把我们的进程分配给多个cpu都是可以的。</div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><b><font color="#FF0000">worker_cpu_affinity </font></b>  0001 0010  0100 1000;     #用于将整个进程分配到cpu上去。8核的话就在前面写完整8位</div></div><ul><li><div>除此之外还有一个跟worker相关的，worker_rlimit_nofile  这个指令是指当我们nginx进程会打开的一个最多的文件，我nginx也会打开文件，正常的文件可能会有 access error日志，往日志里面写东西就代表打开文件。那么nginx会打开多少文件是根据这个指令限制的。</div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>worker_rlimit_nofile  10240;   </div><div>ulimit -n  #查看限制数</div><div>ulimit -n  65535  #可以修改，尽量和 nginx.conf 里的worker_rlimit_nofile 数量保持一致</div></div><div><img src="Nginx调优---木泉课程 2020-8-20 104335 192.168.110_files/Image [12].png" type="image/png" data-filename="Image.png"/>     </div><div><br/></div><ul><li><div>这里有三个error 。分别是不同的日志等级。</div></li></ul><div><img src="Nginx调优---木泉课程 2020-8-20 104335 192.168.110_files/Image [13].png" type="image/png" data-filename="Image.png"/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>#错误日志的等级分别是</div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;"># [ debug | info | notice | warn | error | crit ]</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">debug 是测试的 ， info是显示信息 ，notice 通知 ， warn 警告， error 错误 ， crit  紧急 。状态依次变高</span></div></div><div><img src="Nginx调优---木泉课程 2020-8-20 104335 192.168.110_files/Image [14].png" type="image/png" data-filename="Image.png"/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>tail -fn  1  access.log   # n 1 是每次显示一个</div><div>curl 192.168.1.119  #尝试访问</div></div><div><img src="Nginx调优---木泉课程 2020-8-20 104335 192.168.110_files/Image [15].png" type="image/png" data-filename="Image.png"/></div><ul><li><div>需要制作一个会造成错误的配置</div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>worker_processes  1;</div><div>events {</div><div>    worker_connections  1024;</div><div>}</div><div>http {</div><div>    include       mime.types;</div><div>    default_type  application/octet-stream;</div><div>    sendfile        on;</div><div>    keepalive_timeout  65;</div><div>    upstream  web_discuz {</div><div>                server 192.168.1.120;    </div><div>                server 192.168.1.117;</div><div>            }</div><div>    server {</div><div>        listen       80;</div><div>        server_name  localhost;</div><div>        location / {</div><div>            root   html;</div><div>            index  index.html index.htm;</div><div>        proxy_set_header Host $host;</div><div>        proxy_pass  http://web_discuz;</div><div>        }</div><div>        error_page   500 502 503 504  /50x.html;</div><div>        location = /50x.html {</div><div>            root   html;</div><div>        }</div><div>    }</div><div>}</div></div><ul><li><div>curl后可以看到  access.log 和 error.log 的内容分别为</div></li></ul><div><img src="Nginx调优---木泉课程 2020-8-20 104335 192.168.110_files/Image [16].png" type="image/png" data-filename="Image.png"/></div><div><img src="Nginx调优---木泉课程 2020-8-20 104335 192.168.110_files/Image [17].png" type="image/png" data-filename="Image.png"/></div><ul><li><div>使用了重启之后，注意看 error log的信息，显示了notice。</div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>nginx -s reload</div></div><div><img src="Nginx调优---木泉课程 2020-8-20 104335 192.168.110_files/Image [18].png" type="image/png" data-filename="Image.png"/></div><ul><li><div>那么刚才 notice 在info后面，为什么中间没有显示notice?  因为你默认的就是error，注意这个日志等级是向下兼容的。如果我定义的是info，那么在我的日志后面可以看得到，前面看不到。如果  [ debug | info | notice | warn | error | crit ]  我定义了error ，那么我前面的等级都是看不到的。我们<span style="font-weight: bold; color: rgb(255, 0, 0);">一般是定义到warning</span>上。</div></li></ul><div><img src="Nginx调优---木泉课程 2020-8-20 104335 192.168.110_files/Image [19].png" type="image/png" data-filename="Image.png"/></div><div><span style="font-weight: bold;"><img src="Nginx调优---木泉课程 2020-8-20 104335 192.168.110_files/Image [20].png" type="image/png" data-filename="Image.png"/></span></div><ul><li><div>notice呢只是告诉你，单个进程已经开启了。使用的是epoll模型等等，worker进程启动。</div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>vim  /usr/local/nginx/conf</div><div>--------------------------</div><div>worker_processes 1;</div><div>error_log  logs/error.log  warn;     #定义为warn</div></div><ul><li><div><span style="font-weight: bold;">定义为warn</span>。因为你知道这些notice的定义为epoll什么的信息对管理员来说没有关系。</div></li></ul><div><br/></div><ul><li><div>然后是pid，假如把他删掉，服务就宕了</div></li><li><div>events里面是一个进程里面的最高并发量</div></li></ul><div><img src="Nginx调优---木泉课程 2020-8-20 104335 192.168.110_files/Image [21].png" type="image/png" data-filename="Image.png"/></div><ul><li><div>除此之外还有一个数 multi_accept  ,这个表示你<span style="font-weight: bold; color: rgb(227, 0, 0);">尽可能多的去接收请求</span>。</div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">events {</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">    worker_connections  10240;</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">    multi_accept  on;</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">} </span></div></div><ul><li><div>接下来mime 是媒介类型，比如 html，css，js，mp4</div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>vim   /usr/local/nginx/conf/mime.types</div></div><div><img src="Nginx调优---木泉课程 2020-8-20 104335 192.168.110_files/Image [22].png" type="image/png" data-filename="Image.png"/></div><ul><li><div>前面的是标识，后面的才是格式。我们在<span style="font-weight: bold; color: rgb(255, 0, 0);">识别的时候</span>，是<span style="font-weight: bold; color: rgb(255, 0, 0);">识别后面</span>的。但是我们在<span style="font-weight: bold; color: rgb(255, 0, 0);">配置文件调用</span>的时候，是<span style="font-weight: bold; color: rgb(255, 0, 0);">使用前面</span>的。</div></li><li><div>default_type  application/octet-stream;  是默认的类型</div></li><li><div>log_format 是定义日志类型的格式的</div></li></ul><div><img src="Nginx调优---木泉课程 2020-8-20 104335 192.168.110_files/Image [23].png" type="image/png" data-filename="Image.png"/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>#main  是标签，如果我们把access_log打开了，<b><font color="#FF0000">访问的日志</font></b>显示什么<b><font color="#FF0000">内容</font></b>及格式<b><font color="#FF0000">用的是main格式</font></b>。</div><div>#  'remote_addr -  $remote_user [$time_local]  &quot;request&quot; '  远程的IP地址，用户 ，请求</div><div>#   '$status  $body_bytes_sent  &quot;$http_referer&quot; '  #状态，字节发送多少，http代理</div><div>#  ' &quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;';  #用户的请求，以及调用的转向到哪里</div></div><div><br/></div><ul><li><div>那么我们自己来定义一个</div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>log_format  thinkmo '$remote_addr - &quot;$http_user_agent&quot; &quot;$request&quot;'</div><div>access_log  logs/access.log  thinkmo;           #把定义的thinkmo放到access.log中</div></div><ul><li><div>日志的格式会简单很多</div></li></ul><div><img src="Nginx调优---木泉课程 2020-8-20 104335 192.168.110_files/Image [24].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><ul><li><div>gzip压缩</div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>gzip on;    </div><div>gzip_min_length  1k;    #最小是1kb，1kb以下的东西没必要压缩。</div><div>gzip_buffers  4  16k;   #缓存4到16k</div><div>gzip_htp_version  1.1;</div><div>gzip_comp_level  2;    #压缩等级2</div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">gzip_types   text/plain  application/x-javascript  text/css application/xml;    #压缩的类型</span></div><div><span style="font-size: 9pt; font-family: Monaco;"><b><font color="#FF0000">gzip_vary on</font></b>;</span></div></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div></div><div><br/></div></span>
</div></body></html> 